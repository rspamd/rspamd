# URL Suspect Plugin Configuration
# Module documentation: https://rspamd.com/doc/modules/url_suspect.html

url_suspect {
  # Enable the plugin
  enabled = true;

  # Which URL flags trigger inspection (existing flags, no new flags needed)
  # Available: has_user, numeric, obscured, zw_spaces, no_tld, unnormalised
  process_flags = ["has_user", "numeric", "obscured", "zw_spaces", "no_tld"];

  # Check configuration
  checks {
    # User/password field analysis
    user_password {
      enabled = true;

      # Length thresholds for scoring
      length_thresholds {
        suspicious = 64;     # Score if user field > 64 chars
        long = 128;          # Higher score if > 128
        very_long = 256;     # Even higher if > 256
      }

      # OPTIONAL: Advanced pattern matching
      # Uncomment to enable custom user field patterns
      # pattern_map = "$LOCAL_CONFDIR/local.d/url_suspect_user_patterns.map";

      # OPTIONAL: User blacklist
      # Uncomment to enable user field blacklist
      # blacklist_map = "$LOCAL_CONFDIR/local.d/url_suspect_user_blacklist.map";
    }

    # Numeric IP address analysis
    numeric_ip {
      enabled = true;

      # Scoring for different scenarios
      base_score = 1.5;          # Basic numeric IP
      with_user_score = 4.0;     # Numeric IP + user field

      # Private IP ranges (10.x, 192.168.x, etc.)
      allow_private_ranges = true;
      private_score = 0.5;       # Lower score for private IPs

      # OPTIONAL: Suspicious IP ranges map
      # Uncomment to enable custom IP range checking
      # range_map = "$LOCAL_CONFDIR/local.d/url_suspect_ip_ranges.map";
    }

    # TLD (Top Level Domain) analysis
    tld {
      enabled = true;

      # Built-in suspicious TLDs (no map needed)
      builtin_suspicious = [".tk", ".ml", ".ga", ".cf", ".gq"];
      builtin_score = 3.0;

      # Missing TLD score
      missing_tld_score = 2.0;

      # OPTIONAL: Custom TLD map
      # Uncomment to add additional TLDs to check
      # tld_map = "$LOCAL_CONFDIR/local.d/url_suspect_tlds.map";
    }

    # Unicode and encoding analysis
    unicode {
      enabled = true;

      # All checks use built-in logic (no maps needed)
      check_validity = true;      # Invalid UTF-8 sequences
      check_homographs = true;    # Mixed script homograph attacks
      check_rtl_override = true;  # RTL Unicode override tricks
      check_zero_width = true;    # Zero-width space characters
    }

    # URL structure analysis
    structure {
      enabled = true;

      # Multiple @ signs
      check_multiple_at = true;
      max_at_signs = 2;

      # Backslashes in URL
      check_backslash = true;

      # Excessive dots in hostname
      check_excessive_dots = true;
      max_host_dots = 6;

      # URL length
      check_length = true;
      max_url_length = 2048;

      # OPTIONAL: Suspicious ports map
      # Uncomment to check for unusual ports
      # port_map = "$LOCAL_CONFDIR/local.d/url_suspect_ports.map";
    }
  }

  # Symbol names (can be customized)
  symbols {
    # User/password symbols
    user_password = "URL_USER_PASSWORD";
    user_long = "URL_USER_LONG";
    user_very_long = "URL_USER_VERY_LONG";

    # Numeric IP symbols
    numeric_ip = "URL_NUMERIC_IP";
    numeric_ip_user = "URL_NUMERIC_IP_USER";
    numeric_private = "URL_NUMERIC_PRIVATE_IP";

    # TLD symbols
    no_tld = "URL_NO_TLD";
    suspicious_tld = "URL_SUSPICIOUS_TLD";

    # Unicode symbols
    bad_unicode = "URL_BAD_UNICODE";
    homograph = "URL_HOMOGRAPH_ATTACK";
    rtl_override = "URL_RTL_OVERRIDE";
    zero_width = "URL_ZERO_WIDTH_SPACES";

    # Structure symbols
    multiple_at = "URL_MULTIPLE_AT_SIGNS";
    backslash = "URL_BACKSLASH_PATH";
    excessive_dots = "URL_EXCESSIVE_DOTS";
    very_long = "URL_VERY_LONG";
  }

  # ADVANCED: Global whitelist
  # Uncomment to skip checks for specific domains
  # whitelist_map = "$LOCAL_CONFDIR/local.d/url_suspect_whitelist.map";

  # ADVANCED: Custom checks (disabled by default)
  # Example:
  # custom_checks {
  #   my_check = <<EOD
  #     return function(task, url, settings)
  #       local host = url:get_host()
  #       if host and host:match("suspicious") then
  #         return {
  #           symbol = "MY_SUSPICIOUS_URL",
  #           score = 5.0,
  #           options = {host}
  #         }
  #       end
  #     end
  # EOD;
  # }

  # Backward compatibility with R_SUSPICIOUS_URL
  # When enabled, R_SUSPICIOUS_URL symbol is inserted if any URL_* symbols fire
  compat_mode = true;

  .include(try=true,priority=5) "${DBDIR}/dynamic/url_suspect.conf"
  .include(try=true,priority=1,duplicate=merge) "$LOCAL_CONFDIR/local.d/url_suspect.conf"
  .include(try=true,priority=10) "$LOCAL_CONFDIR/override.d/url_suspect.conf"
}
